<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volt</title>

  <!-- PWA chrome -->
  <meta name="theme-color" content="#ff3ea5"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/manifest.webmanifest"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --volt-pink:#ff3ea5;
      --volt-pink-2:#ff6bb5;
      --volt-pink-3:#ffa3d1;
    }
    .volt-card{background:#fff;border-radius:16px;box-shadow:0 8px 28px rgba(255,62,165,.12),0 2px 6px rgba(0,0,0,.05)}
    .volt-pill{border-radius:9999px}
    .volt-gradient{background:linear-gradient(135deg,var(--volt-pink) 0%,var(--volt-pink-2) 45%,var(--volt-pink-3) 100%)}
    .volt-soft{background:linear-gradient(180deg, rgba(255,62,165,.06), rgba(255,62,165,.00))}
    .volt-btn{transition:transform .05s ease}
    .volt-btn:active{transform:translateY(1px)}
    .volt-input:focus{outline:none;box-shadow:0 0 0 3px rgba(255,62,165,.25)}
  </style>
</head>

<body class="min-h-screen volt-soft">
  <!-- Header -->
  <div class="volt-gradient text-white">
    <div class="max-w-4xl mx-auto px-6 py-6">
      <h1 class="text-3xl font-extrabold tracking-tight">‚ö° Volt</h1>
      <p class="opacity-95">Hot-pink PWA for live chat + archive</p>
    </div>
  </div>

  <div class="max-w-4xl mx-auto p-6 space-y-6">
    <!-- Test API -->
    <div class="volt-card p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Backend</h2>
      <div class="flex gap-3 mb-4">
        <button id="btnPing" class="volt-btn volt-pill bg-pink-600 text-white px-4 py-2 hover:bg-pink-700">Test Ping</button>
        <button id="btnMemory" class="volt-btn volt-pill bg-fuchsia-600 text-white px-4 py-2 hover:bg-fuchsia-700">Test Memory</button>
      </div>
      <div id="results" class="bg-pink-50/40 border border-pink-100 rounded-xl p-4 min-h-20">
        <p class="text-pink-700/80">Click a button to test‚Ä¶</p>
      </div>
    </div>

    <!-- Live Chat -->
    <div class="volt-card p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Live Chat</h2>
      <div id="chatLog" class="border border-pink-100 rounded-xl p-3 h-72 overflow-y-auto bg-white mb-3">
        <div class="text-gray-500">Say hi üëã ‚Äî works even without an API key (echo mode).</div>
      </div>
      <div class="flex gap-2">
        <textarea id="chatInput" class="volt-input flex-1 p-3 border border-pink-200 rounded-xl" placeholder="Type a message‚Ä¶"></textarea>
        <button id="btnSend" class="volt-btn volt-pill bg-pink-600 text-white px-5 py-2 hover:bg-pink-700">Send</button>
      </div>
    </div>

    <!-- ChatGPT Archive -->
    <div class="volt-card p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold text-gray-800">Conversation Archive</h2>
        <button id="btnReload" class="volt-btn text-sm px-3 py-1 volt-pill bg-pink-50 hover:bg-pink-100 text-pink-700">Reload</button>
      </div>

      <input id="search" placeholder="Search titles & messages‚Ä¶" class="volt-input w-full p-3 border border-pink-200 rounded-xl mb-3"/>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><ul id="list" class="space-y-2"></ul></div>
        <div>
          <div id="viewer" class="border border-pink-100 rounded-xl p-3 h-[420px] overflow-y-auto bg-white">
            <p class="text-gray-500">Select a conversation‚Ä¶</p>
          </div>
        </div>
      </div>

      <div id="archiveNote" class="text-xs text-gray-500 mt-3"></div>
    </div>
  </div>

  <!-- =================== JS (works with your existing functions) =================== -->
  <script>
    const $ = id => document.getElementById(id);

    function show(message, ok = true) {
      $('results').innerHTML = `<pre class="${ok ? 'text-green-700' : 'text-rose-600'} whitespace-pre-wrap text-sm">${message}</pre>`;
    }

    // Ping
    async function testPing() {
      try {
        show('Testing ping‚Ä¶', true);
        const res = await fetch('/.netlify/functions/ping');
        const raw = await res.text(); let data; try{data=JSON.parse(raw)}catch{}
        const ok = res.ok && (data?.ok===true || data?.msg==='pong' || data?.message);
        ok ? show(`‚úÖ Ping:\n${JSON.stringify(data ?? {raw}, null, 2)}`, true)
           : show(`‚ùå Ping error:\nHTTP ${res.status}\n${raw}`, false);
      } catch (e) { show(`‚ùå Ping failed: ${e.message}`, false); }
    }

    // Memory
    async function testMemory() {
      try {
        show('Testing memory‚Ä¶', true);
        const res = await fetch('/.netlify/functions/memory');
        const raw = await res.text(); let data; try{data=JSON.parse(raw)}catch{}
        const ok = res.ok && (data?.ok===true || data?.status==='success' ||
                 (typeof data?.message==='string' && data.message.includes('alive')) ||
                 (!data && raw.trim()!==''));
        ok ? show(`‚úÖ Memory:\n${JSON.stringify(data ?? {raw}, null, 2)}`, true)
           : show(`‚ùå Memory error:\nHTTP ${res.status}\n${raw}`, false);
      } catch (e) { show(`‚ùå Memory failed: ${e.message}`, false); }
    }

    // Live chat
    function addBubble(role, text){
      const log=$('chatLog');
      const color = role==='user' ? 'bg-blue-50 border-blue-200' : 'bg-pink-50 border-pink-200';
      const name  = role==='user' ? 'You' : 'Volt';
      const safe=(text||'').replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]));
      log.innerHTML+=`<div class="mb-2">
        <div class="text-xs ${role==='user'?'text-blue-700':'text-pink-700'} font-semibold">${name}</div>
        <div class="whitespace-pre-wrap border ${color} rounded-xl p-2">${safe}</div>
      </div>`;
      log.scrollTop=log.scrollHeight;
    }
    async function sendChat(){
      const btn=$('btnSend'); const input=$('chatInput');
      const msg=input.value.trim(); if(!msg) return; input.value=''; addBubble('user',msg);
      btn.disabled=true;
      try{
        const res=await fetch('/.netlify/functions/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
        const raw=await res.text(); let data; try{data=JSON.parse(raw)}catch{}
        if(res.ok && data?.ok) addBubble('assistant', data.reply||'(empty reply)');
        else addBubble('assistant', `Error: HTTP ${res.status}\n${raw}`);
      }catch(e){ addBubble('assistant', `Error: ${e.message}`); }
      finally{ btn.disabled=false; input.focus(); }
    }

    // Archive
    async function fetchList(q=''){
      const url=q?`/.netlify/functions/conversations?q=${encodeURIComponent(q)}`:'/.netlify/functions/conversations';
      const res=await fetch(url); const data=await res.json();
      const list=data.conversations||[]; const sample=!!data.sample;
      const ul=$('list'); ul.innerHTML='';
      if(list.length===0){ ul.innerHTML='<li class="text-gray-500">No conversations found.</li>'; }
      else{
        for(const c of list){
          const li=document.createElement('li');
          li.className="border border-pink-100 rounded-xl p-3 hover:bg-pink-50 cursor-pointer";
          li.innerHTML=`<div class="font-semibold">${c.title||'Untitled'}</div>
            <div class="text-xs text-gray-500">${c.count??0} messages ¬∑ ${c.created?new Date(c.created*1000||c.created).toLocaleString():''}</div>`;
          li.addEventListener('click',()=>openThread(c.id));
          ul.appendChild(li);
        }
      }
      $('archiveNote').textContent = sample ? 'Showing sample data. Upload data/conversations.json to see your real history.' : '';
    }
    async function openThread(id){
      try{
        const res=await fetch(`/.netlify/functions/conversations?id=${encodeURIComponent(id)}`);
        const data=await res.json(); const box=$('viewer');
        if(data?.ok && data?.thread){
          const msgs=data.thread.messages||[];
          if(msgs.length===0){ box.innerHTML='<div class="text-gray-500">No messages in this thread.</div>'; return; }
          box.innerHTML=msgs.map(m=>`
            <div class="mb-3">
              <div class="text-xs ${m.role==='assistant'?'text-pink-700':'text-blue-700'} font-semibold">${m.role}</div>
              <div class="whitespace-pre-wrap bg-white border border-pink-100 rounded-xl p-2">${(m.content||'').replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</div>
              <div class="text-[10px] text-gray-400 mt-1">${m.ts?new Date(m.ts*1000||m.ts).toLocaleString():''}</div>
            </div>`).join('');
        }else{
          $('viewer').innerHTML=`<div class="mb-3">
              <div class="text-xs text-blue-700 font-semibold">user</div>
              <div class="whitespace-pre-wrap bg-white border border-pink-100 rounded-xl p-2">Sample: show me my archive</div>
              <div class="text-[10px] text-gray-400 mt-1">${new Date().toLocaleString()}</div>
            </div>
            <div class="mb-3">
              <div class="text-xs text-pink-700 font-semibold">assistant</div>
              <div class="whitespace-pre-wrap bg-white border border-pink-100 rounded-xl p-2">Archive viewer is alive ‚úÖ</div>
              <div class="text-[10px] text-gray-400 mt-1">${new Date().toLocaleString()}</div>
            </div>`;
        }
      }catch(e){ $('viewer').innerHTML=`<div class="text-rose-600">Failed to load thread: ${e.message}</div>`; }
    }

    // Wire + boot
    $('btnPing').addEventListener('click', testPing);
    $('btnMemory').addEventListener('click', testMemory);
    $('btnReload').addEventListener('click', ()=>fetchList($('search').value));
    $('search').addEventListener('input', e=>fetchList(e.target.value));
    $('btnSend').addEventListener('click', sendChat);
    $('chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }});

    document.addEventListener('DOMContentLoaded', async ()=>{
      show('Page loaded. Ready to test.', true);
      await fetchList('');
    });
  </script>
</body>
</html>
