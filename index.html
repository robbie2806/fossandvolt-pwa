<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volt Memory Bank</title>
  <meta name="theme-color" content="#7c3aed"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">üß† Volt Memory Bank</h1>
      <p class="text-gray-600">Test backend, browse archive, and chat with Volt in your PWA.</p>
    </div>

    <!-- Test API -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Backend</h2>
      <div class="flex gap-3 mb-4">
        <button id="btnPing" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Test Ping</button>
        <button id="btnMemory" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Test Memory</button>
      </div>
      <div id="results" class="bg-gray-50 p-4 rounded-lg min-h-20">
        <p class="text-gray-500">Click a button to test‚Ä¶</p>
      </div>
    </div>

    <!-- Chat (Live) -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Live Chat with Volt</h2>
      <div id="chatLog" class="border border-gray-200 rounded-lg p-3 h-72 overflow-y-auto bg-gray-50 mb-3">
        <div class="text-gray-500">Say hi üëã ‚Äî this works even without an API key (echo mode).</div>
      </div>
      <div class="flex gap-2">
        <textarea id="chatInput" class="flex-1 p-3 border border-gray-300 rounded-lg" placeholder="Type a message‚Ä¶"></textarea>
        <button id="btnSend" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Send</button>
      </div>
    </div>

    <!-- ChatGPT Archive -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold text-gray-800">ChatGPT Conversation Archive</h2>
        <button id="btnReload" class="text-sm px-3 py-1 rounded bg-gray-100 hover:bg-gray-200">Reload</button>
      </div>

      <input id="search" placeholder="Search titles & messages‚Ä¶" class="w-full p-3 border border-gray-300 rounded-lg mb-3"/>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <ul id="list" class="space-y-2"></ul>
        </div>
        <div>
          <div id="viewer" class="border border-gray-200 rounded-lg p-3 h-[420px] overflow-y-auto bg-gray-50">
            <p class="text-gray-500">Select a conversation‚Ä¶</p>
          </div>
        </div>
      </div>

      <div id="archiveNote" class="text-xs text-gray-500 mt-3"></div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    // ---------- UI helper ----------
    function show(message, ok = true) {
      const el = $('results');
      el.innerHTML = `<pre class="${ok ? 'text-green-600' : 'text-red-600'} whitespace-pre-wrap text-sm">${message}</pre>`;
    }

    // ---------- Ping ----------
    async function testPing() {
      try {
        show('Testing ping‚Ä¶', true);
        const res = await fetch('/.netlify/functions/ping');
        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { data = null; }
        const ok = res.ok && (data?.ok === true || data?.msg === 'pong' || data?.message);
        if (ok) show(`‚úÖ Ping:\n${JSON.stringify(data ?? {raw}, null, 2)}`, true);
        else show(`‚ùå Ping error:\nHTTP ${res.status}\n${raw}`, false);
      } catch (err) { show(`‚ùå Ping failed: ${err.message}`, false); }
    }

    // ---------- Memory (works with current GET memory.js) ----------
    async function testMemory() {
      try {
        show('Testing memory‚Ä¶', true);
        const res = await fetch('/.netlify/functions/memory');
        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { data = null; }
        const ok = res.ok && (
          data?.ok === true ||
          data?.status === 'success' ||
          (typeof data?.message === 'string' && data.message.includes('alive')) ||
          (!data && raw.trim() !== '')
        );
        if (ok) show(`‚úÖ Memory:\n${JSON.stringify(data ?? {raw}, null, 2)}`, true);
        else show(`‚ùå Memory error:\nHTTP ${res.status}\n${raw}`, false);
      } catch (err) { show(`‚ùå Memory failed: ${err.message}`, false); }
    }

    // ---------- Live Chat ----------
    function addBubble(role, text) {
      const log = $('chatLog');
      const color = role === 'user' ? 'bg-blue-50 border-blue-200' : 'bg-purple-50 border-purple-200';
      const name  = role === 'user' ? 'You' : 'Volt';
      const safe = (text || '').replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]));
      log.innerHTML += `<div class="mb-2">
        <div class="text-xs ${role === 'user' ? 'text-blue-700' : 'text-purple-700'} font-semibold">${name}</div>
        <div class="whitespace-pre-wrap border ${color} rounded p-2">${safe}</div>
      </div>`;
      log.scrollTop = log.scrollHeight;
    }

    async function sendChat() {
      const btn = $('btnSend');
      const input = $('chatInput');
      const msg = input.value.trim();
      if (!msg) return;
      input.value = '';
      addBubble('user', msg);

      btn.disabled = true;
      try {
        const res = await fetch('/.netlify/functions/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg })
        });
        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { data = null; }
        if (res.ok && data?.ok) addBubble('assistant', data.reply || '(empty reply)');
        else addBubble('assistant', `Error: HTTP ${res.status}\n${raw}`);
      } catch (e) {
        addBubble('assistant', `Error: ${e.message}`);
      } finally {
        btn.disabled = false;
        input.focus();
      }
    }

    // ---------- Archive ----------
    async function fetchList(q = '') {
      const url = q ? `/.netlify/functions/conversations?q=${encodeURIComponent(q)}` : '/.netlify/functions/conversations';
      const res = await fetch(url);
      const data = await res.json();
      const list = data.conversations || [];
      const sample = !!data.sample;

      const ul = $('list');
      ul.innerHTML = '';
      if (list.length === 0) {
        ul.innerHTML = `<li class="text-gray-500">No conversations found.</li>`;
      } else {
        for (const c of list) {
          const li = document.createElement('li');
          li.className = "border border-gray-200 rounded-lg p-3 hover:bg-gray-50 cursor-pointer";
          li.innerHTML = `
            <div class="font-semibold">${c.title || 'Untitled'}</div>
            <div class="text-xs text-gray-500">${c.count ?? 0} messages ¬∑ ${c.created ? new Date(c.created*1000 || c.created).toLocaleString() : ''}</div>
          `;
          li.addEventListener('click', () => openThread(c.id));
          ul.appendChild(li);
        }
      }
      $('archiveNote').textContent = sample
        ? 'Showing sample data. Upload data/conversations.json to see your real history.'
        : '';
    }

    async function openThread(id) {
      try {
        const res = await fetch(`/.netlify/functions/conversations?id=${encodeURIComponent(id)}`);
        const data = await res.json();
        const box = $('viewer');
        if (data?.ok && data?.thread) {
          const t = data.thread;
          const msgs = t.messages || [];
          if (msgs.length === 0) {
            box.innerHTML = `<div class="text-gray-500">No messages in this thread.</div>`;
            return;
          }
          box.innerHTML = msgs.map(m => `
            <div class="mb-3">
              <div class="text-xs ${m.role === 'assistant' ? 'text-purple-700' : 'text-blue-700'} font-semibold">${m.role}</div>
              <div class="whitespace-pre-wrap bg-white border border-gray-200 rounded p-2">${(m.content || '').replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</div>
              <div class="text-[10px] text-gray-400 mt-1">${m.ts ? new Date(m.ts*1000 || m.ts).toLocaleString() : ''}</div>
            </div>
          `).join('');
        } else {
          $('viewer').innerHTML = `
            <div class="mb-3">
              <div class="text-xs text-blue-700 font-semibold">user</div>
              <div class="whitespace-pre-wrap bg-white border border-gray-200 rounded p-2">Sample: show me my archive</div>
              <div class="text-[10px] text-gray-400 mt-1">${new Date().toLocaleString()}</div>
            </div>
            <div class="mb-3">
              <div class="text-xs text-purple-700 font-semibold">assistant</div>
              <div class="whitespace-pre-wrap bg-white border border-gray-200 rounded p-2">Archive viewer is alive ‚úÖ</div>
              <div class="text-[10px] text-gray-400 mt-1">${new Date().toLocaleString()}</div>
            </div>
          `;
        }
      } catch (e) {
        $('viewer').innerHTML = `<div class="text-red-600">Failed to load thread: ${e.message}</div>`;
      }
    }

    // Wire buttons + keys
    $('btnPing').addEventListener('click', testPing);
    $('btnMemory').addEventListener('click', testMemory);
    $('btnReload').addEventListener('click', () => fetchList($('search').value));
    $('search').addEventListener('input', e => fetchList(e.target.value));
    $('btnSend').addEventListener('click', sendChat);
    $('chatInput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } });

    // Boot
    document.addEventListener('DOMContentLoaded', async () => {
      show('Page loaded. Ready to test.', true);
      await fetchList('');
    });
  </script>
</body>
</html>
