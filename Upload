import { getStore } from "@netlify/blobs";

export const config = { path: "/api/upload" };

export default async (req) => {
  if (req.method === "OPTIONS")
    return new Response(null, { status: 204 });

  if (req.method !== "POST")
    return new Response("Use POST", { status: 405 });

  const contentType = req.headers.get("content-type") || "";
  if (!contentType.includes("multipart/form-data"))
    return new Response("Send form-data", { status: 400 });

  const form = await req.formData();
  const file = form.get("file");
  if (!file || typeof file === "string")
    return new Response("No file", { status: 400 });

  const store = getStore("volt-uploads");
  const id = crypto.randomUUID();
  const key = `upload:${id}:${file.name || "file"}`;
  await store.set(key, await file.arrayBuffer(), {
    contentType: file.type || "application/octet-stream",
  });

  // Signed URL (temporary) for preview
  const url = await store.getSignedUrl(key, { method: "GET", expiresIn: 60 * 60 });

  return new Response(JSON.stringify({ ok: true, id, url }), {
    headers: { "content-type": "application/json" },
  });
};
